local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local ESPContainer = {}

local function CreateESP(player)
    if player == LocalPlayer then return end

    local Box = Drawing.new("Square")
    Box.Thickness = 2
    Box.Color = Color3.fromRGB(255,255,255)
    Box.Filled = false
    Box.Visible = false

    local Name = Drawing.new("Text")
    Name.Size = 13
    Name.Center = true
    Name.Outline = true
    Name.Color = Color3.fromRGB(255,255,255)
    Name.Visible = false

    local DistanceText = Drawing.new("Text")
    DistanceText.Size = 13
    DistanceText.Center = true
    DistanceText.Outline = true
    DistanceText.Color = Color3.fromRGB(255,255,255)
    DistanceText.Visible = false

    local HealthBar = Drawing.new("Line")
    HealthBar.Thickness = 3
    HealthBar.Visible = false

    ESPContainer[player] = {
        Box = Box,
        Name = Name,
        Distance = DistanceText,
        HealthBar = HealthBar
    }

    RunService.RenderStepped:Connect(function()
        if not player.Character 
        or not player.Character:FindFirstChild("HumanoidRootPart") 
        or not LocalPlayer.Character 
        or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then

            Box.Visible = false
            Name.Visible = false
            DistanceText.Visible = false
            HealthBar.Visible = false
            return
        end

        local HRP = player.Character.HumanoidRootPart
        local LocalHRP = LocalPlayer.Character.HumanoidRootPart
        local Humanoid = player.Character:FindFirstChildOfClass("Humanoid")

        local Vector, OnScreen = Camera:WorldToViewportPoint(HRP.Position)

        if OnScreen then
            local Top = Camera:WorldToViewportPoint(HRP.Position + Vector3.new(0,3,0))
            local Bottom = Camera:WorldToViewportPoint(HRP.Position - Vector3.new(0,3,0))
            local Height = math.abs(Top.Y - Bottom.Y)
            local Width = Height / 1.5

            Box.Size = Vector2.new(Width, Height)
            Box.Position = Vector2.new(Vector.X - Width/2, Vector.Y - Height/2)
            Box.Visible = true

            Name.Text = player.Name
            Name.Position = Vector2.new(Vector.X, Box.Position.Y - 15)
            Name.Visible = true

            local Distance = (HRP.Position - LocalHRP.Position).Magnitude
            DistanceText.Text = math.floor(Distance) .. "m"
            DistanceText.Position = Vector2.new(Vector.X, Box.Position.Y + Height + 2)
            DistanceText.Visible = true

            if Humanoid then
                local HealthPercent = math.clamp(Humanoid.Health / Humanoid.MaxHealth, 0, 1)

                local r = 255 * (1 - HealthPercent)
                local g = 255 * HealthPercent

                HealthBar.Color = Color3.fromRGB(r, g, 0)

                HealthBar.From = Vector2.new(Box.Position.X - 6, Box.Position.Y + Height)
                HealthBar.To = Vector2.new(Box.Position.X - 6, Box.Position.Y + (Height * (1 - HealthPercent)))
                HealthBar.Visible = true
            end
        else
            Box.Visible = false
            Name.Visible = false
            DistanceText.Visible = false
            HealthBar.Visible = false
        end
    end)
end

for _, player in ipairs(Players:GetPlayers()) do
    CreateESP(player)
end

Players.PlayerAdded:Connect(CreateESP)

Players.PlayerRemoving:Connect(function(player)
    if ESPContainer[player] then
        for _, v in pairs(ESPContainer[player]) do
            v:Remove()
        end
        ESPContainer[player] = nil
    end
end)
