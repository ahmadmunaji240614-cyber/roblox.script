local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = game.CoreGui

local Frame = Instance.new("Frame")
Frame.Parent = ScreenGui
Frame.Size = UDim2.new(0,200,0,100)
Frame.Position = UDim2.new(0.3,0,0.3,0)
Frame.BackgroundColor3 = Color3.fromRGB(25,25,25)
Frame.Active = true
Frame.Draggable = true

local Title = Instance.new("TextLabel")
Title.Parent = Frame
Title.Size = UDim2.new(1,0,0,30)
Title.Text = "ESP MENU"
Title.BackgroundColor3 = Color3.fromRGB(35,35,35)
Title.TextColor3 = Color3.new(1,1,1)

local Toggle = Instance.new("TextButton")
Toggle.Parent = Frame
Toggle.Size = UDim2.new(1,-20,0,40)
Toggle.Position = UDim2.new(0,10,0,45)
Toggle.Text = "ESP : OFF"
Toggle.BackgroundColor3 = Color3.fromRGB(50,50,50)
Toggle.TextColor3 = Color3.new(1,1,1)

local ESPEnabled = false

Toggle.MouseButton1Click:Connect(function()
    ESPEnabled = not ESPEnabled
    Toggle.Text = ESPEnabled and "ESP : ON" or "ESP : OFF"
end)

local ESPColor = Color3.fromRGB(255,0,0)

function CreateESP(player)
    if player == LocalPlayer then return end

    local Box = Drawing.new("Square")
    Box.Color = ESPColor
    Box.Thickness = 2
    Box.Filled = false

    local Line = Drawing.new("Line")
    Line.Color = ESPColor
    Line.Thickness = 2

    local Name = Drawing.new("Text")
    Name.Size = 14
    Name.Center = true
    Name.Outline = true
    Name.Color = ESPColor

    local HealthText = Drawing.new("Text")
    HealthText.Size = 13
    HealthText.Center = true
    HealthText.Outline = true
    HealthText.Color = Color3.fromRGB(0,255,0)

    RunService.RenderStepped:Connect(function()
        if not ESPEnabled then
            Box.Visible = false
            Line.Visible = false
            Name.Visible = false
            HealthText.Visible = false
            return
        end

        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") and player.Character:FindFirstChild("Humanoid") then
            
            local hrp = player.Character.HumanoidRootPart
            local humanoid = player.Character.Humanoid
            
            local pos, onScreen = Camera:WorldToViewportPoint(hrp.Position)

            if onScreen then
                local size = (Camera:WorldToViewportPoint(hrp.Position + Vector3.new(0,3,0)).Y -
                             Camera:WorldToViewportPoint(hrp.Position - Vector3.new(0,3,0)).Y)

                local boxSize = Vector2.new(size/1.5, size)
                local boxPos = Vector2.new(pos.X - boxSize.X/2, pos.Y - boxSize.Y/2)

                Box.Size = boxSize
                Box.Position = boxPos
                Box.Visible = true

                Line.From = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y)
                Line.To = Vector2.new(pos.X, pos.Y)
                Line.Visible = true

                Name.Position = Vector2.new(pos.X, boxPos.Y - 15)
                Name.Text = player.Name
                Name.Visible = true

                HealthText.Position = Vector2.new(pos.X, boxPos.Y + boxSize.Y + 5)
                HealthText.Text = "HP: "..math.floor(humanoid.Health)
                HealthText.Visible = true
            else
                Box.Visible = false
                Line.Visible = false
                Name.Visible = false
                HealthText.Visible = false
            end
        end
    end)
end

for _, player in pairs(Players:GetPlayers()) do
    CreateESP(player)
end

Players.PlayerAdded:Connect(function(player)
    CreateESP(player)
end)
