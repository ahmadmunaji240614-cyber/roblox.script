local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local ESPEnabled = true
local ESPContainer = {}

-- ================= GUI =================

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = game.CoreGui

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0,200,0,100)
MainFrame.Position = UDim2.new(0.5,-100,0.5,-50)
MainFrame.BackgroundColor3 = Color3.fromRGB(25,25,25)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner", MainFrame)

local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(1,-20,0,40)
ToggleButton.Position = UDim2.new(0,10,0,30)
ToggleButton.BackgroundColor3 = Color3.fromRGB(40,40,40)
ToggleButton.TextColor3 = Color3.fromRGB(255,255,255)
ToggleButton.Text = "ESP : ON"
ToggleButton.TextSize = 16
ToggleButton.Parent = MainFrame

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1,0,0,25)
Title.BackgroundTransparency = 1
Title.Text = "ESP MENU"
Title.TextColor3 = Color3.fromRGB(255,255,255)
Title.TextSize = 18
Title.Parent = MainFrame

-- ================= ESP =================

local function CreateESP(player)
    if player == LocalPlayer then return end

    local Box = Drawing.new("Square")
    Box.Thickness = 2
    Box.Color = Color3.fromRGB(255,0,0)
    Box.Filled = false
    Box.Visible = false

    local Name = Drawing.new("Text")
    Name.Size = 13
    Name.Center = true
    Name.Outline = true
    Name.Color = Color3.fromRGB(255,255,255)
    Name.Visible = false

    local DistanceText = Drawing.new("Text")
    DistanceText.Size = 13
    DistanceText.Center = true
    DistanceText.Outline = true
    DistanceText.Color = Color3.fromRGB(255,255,255)
    DistanceText.Visible = false

    local HealthText = Drawing.new("Text")
    HealthText.Size = 13
    HealthText.Center = true
    HealthText.Outline = true
    HealthText.Visible = false

    ESPContainer[player] = {
        Box = Box,
        Name = Name,
        Distance = DistanceText,
        Health = HealthText
    }

    RunService.RenderStepped:Connect(function()
        if not ESPEnabled then
            Box.Visible = false
            Name.Visible = false
            DistanceText.Visible = false
            HealthText.Visible = false
            return
        end

        if not player.Character 
        or not player.Character:FindFirstChild("HumanoidRootPart") 
        or not LocalPlayer.Character 
        or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then

            Box.Visible = false
            Name.Visible = false
            DistanceText.Visible = false
            HealthText.Visible = false
            return
        end

        local HRP = player.Character.HumanoidRootPart
        local LocalHRP = LocalPlayer.Character.HumanoidRootPart
        local Humanoid = player.Character:FindFirstChildOfClass("Humanoid")

        local Vector, OnScreen = Camera:WorldToViewportPoint(HRP.Position)

        if OnScreen then
            local Top = Camera:WorldToViewportPoint(HRP.Position + Vector3.new(0,3,0))
            local Bottom = Camera:WorldToViewportPoint(HRP.Position - Vector3.new(0,3,0))
            local Height = math.abs(Top.Y - Bottom.Y)
            local Width = Height / 1.5

            Box.Size = Vector2.new(Width, Height)
            Box.Position = Vector2.new(Vector.X - Width/2, Vector.Y - Height/2)
            Box.Visible = true

            Name.Text = player.Name
            Name.Position = Vector2.new(Vector.X, Box.Position.Y - 15)
            Name.Visible = true

            local Distance = (HRP.Position - LocalHRP.Position).Magnitude
            DistanceText.Text = math.floor(Distance) .. "m"
            DistanceText.Position = Vector2.new(Vector.X, Box.Position.Y + Height + 2)
            DistanceText.Visible = true

            if Humanoid then
                local HealthPercent = math.clamp(Humanoid.Health / Humanoid.MaxHealth, 0, 1)
                local PercentValue = math.floor(HealthPercent * 100)

                local r = 255 * (1 - HealthPercent)
                local g = 255 * HealthPercent

                HealthText.Text = PercentValue .. "%"
                HealthText.Color = Color3.fromRGB(r, g, 0)
                HealthText.Position = Vector2.new(Vector.X, Box.Position.Y + Height + 15)
                HealthText.Visible = true
            end
        else
            Box.Visible = false
            Name.Visible = false
            DistanceText.Visible = false
            HealthText.Visible = false
        end
    end)
end

-- Toggle
ToggleButton.MouseButton1Click:Connect(function()
    ESPEnabled = not ESPEnabled
    ToggleButton.Text = ESPEnabled and "ESP : ON" or "ESP : OFF"
end)

-- Player loop
for _, player in ipairs(Players:GetPlayers()) do
    CreateESP(player)
end

Players.PlayerAdded:Connect(CreateESP)

Players.PlayerRemoving:Connect(function(player)
    if ESPContainer[player] then
        for _, v in pairs(ESPContainer[player]) do
            v:Remove()
        end
        ESPContainer[player] = nil
    end
end)
